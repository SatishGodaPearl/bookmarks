<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>gwbrowser.fileswidget</title>
    
      <link rel="stylesheet" href="../../_static/pygments.css">
      <link rel="stylesheet" href="../../_static/theme.css">
      
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>

      <!-- sphinx script_files -->
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>

      
      <script src="../../_static/theme-vendors.js"></script>
      <script src="../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" /> 
  </head>

  <body><div id="app" class="theme-container" :class="pageClasses">
      <!--<navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../index.html" class="home-link">
    
      <img class="logo" src="../../_static/custom.png" alt="doit logo"/>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div> -->

      <!--
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
</div>
<h3><a href="../../index.html">Table of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Bookmarks &amp; Assets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../annotations.html">Annotations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files.html">Task Folders &amp; Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installing From Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maya.html">Maya</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">Python Modules Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contact.html">Contact</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../licence.html">Licence</a></li>
</ul>

        </sidebar> -->

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Module code</a> &raquo;</li>
    
      <li><a href="../gwbrowser.html">gwbrowser</a> &raquo;</li>
    
    <li>gwbrowser.fileswidget</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main">
            
  <h1>Source code for gwbrowser.fileswidget</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;Defines the models, threads and context menus needed to browser the files of</span>
<span class="sd">a asset.</span>

<span class="sd">``FilesModel`` is responsible for storing file-data. There is a key design</span>
<span class="sd">choice determining the model&#39;s overall functionality: we&#39;re interested in</span>
<span class="sd">getting an overview of all files contained in an asset. The reason for this is</span>
<span class="sd">that files are sometimes are tucked away into subfolders and are hard to get to.</span>
<span class="sd">GWBrowser will expand all sub-folders, get all files inside them and present the</span>
<span class="sd">items as a flat list that can be filtered later.</span>

<span class="sd">Note:</span>
<span class="sd">    We&#39;using Python 3&#39;s ``scandir.walk()`` to querry the filesystem. This is</span>
<span class="sd">    because of performance considerations, on my test ``scandir`` outperformed</span>
<span class="sd">    Qt&#39;s ``QDirIterator``. GWBrowser uses a custom build of ``scandir``</span>
<span class="sd">    comptible with Python 2.7.</span>

<span class="sd">``FilesModel`` differs from the other models as in it doesn&#39;t load all necessary</span>
<span class="sd">data in the main-thread. It instead relies on workers to querry and set</span>
<span class="sd">addittional data. The model will also try to generate thumbnails for any</span>
<span class="sd">``OpenImageIO`` readable file-format via its workers.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>

<span class="kn">from</span> <span class="nn">PySide2</span> <span class="k">import</span> <span class="n">QtWidgets</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtGui</span>

<span class="kn">from</span> <span class="nn">gwbrowser.basecontextmenu</span> <span class="k">import</span> <span class="n">BaseContextMenu</span>
<span class="kn">from</span> <span class="nn">gwbrowser.baselistwidget</span> <span class="k">import</span> <span class="n">BaseInlineIconWidget</span>
<span class="kn">from</span> <span class="nn">gwbrowser.baselistwidget</span> <span class="k">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">gwbrowser.baselistwidget</span> <span class="k">import</span> <span class="n">FilterProxyModel</span>
<span class="kn">from</span> <span class="nn">gwbrowser.baselistwidget</span> <span class="k">import</span> <span class="n">initdata</span>

<span class="kn">import</span> <span class="nn">gwbrowser.common</span> <span class="k">as</span> <span class="nn">common</span>
<span class="kn">from</span> <span class="nn">gwbrowser.settings</span> <span class="k">import</span> <span class="n">AssetSettings</span>
<span class="kn">from</span> <span class="nn">gwbrowser.settings</span> <span class="k">import</span> <span class="n">local_settings</span>
<span class="kn">from</span> <span class="nn">gwbrowser.delegate</span> <span class="k">import</span> <span class="n">FilesWidgetDelegate</span>

<span class="kn">from</span> <span class="nn">gwbrowser.imagecache</span> <span class="k">import</span> <span class="n">ImageCache</span>
<span class="kn">from</span> <span class="nn">gwbrowser.imagecache</span> <span class="k">import</span> <span class="n">ImageCacheWorker</span>

<span class="kn">from</span> <span class="nn">gwbrowser.threads</span> <span class="k">import</span> <span class="n">BaseThread</span>
<span class="kn">from</span> <span class="nn">gwbrowser.threads</span> <span class="k">import</span> <span class="n">BaseWorker</span>
<span class="kn">from</span> <span class="nn">gwbrowser.threads</span> <span class="k">import</span> <span class="n">Unique</span>


<span class="k">def</span> <span class="nf">qlast_modified</span><span class="p">(</span><span class="n">n</span><span class="p">):</span> <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDateTime</span><span class="o">.</span><span class="n">fromMSecsSinceEpoch</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_index</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Decorator to validate an index&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This wrapper will make sure the passed parameters are ok to pass onto</span>
<span class="sd">        OpenImageIO. We will also update the index value here.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func_wrapper</span>


<div class="viewcode-block" id="FileInfoWorker"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FileInfoWorker">[docs]</a><span class="k">class</span> <span class="nc">FileInfoWorker</span><span class="p">(</span><span class="n">BaseWorker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The worker associated with the ``FileInfoThread``.</span>

<span class="sd">    The worker is responsible for loading the file-size, last modified</span>
<span class="sd">    timestamps, saved flags and descriptions. These loads involve the</span>
<span class="sd">    file-system and can be expensive to perform.</span>

<span class="sd">    The worker performs  the same function as ``SecondaryFileInfoWorker`` but it</span>
<span class="sd">    has it own queue and is concerned with iterating over **only** the visible</span>
<span class="sd">    file-items.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Unique</span><span class="p">(</span><span class="mi">999999</span><span class="p">)</span>
    <span class="n">indexes_in_progress</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@validate_index</span>
    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QModelIndex</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The main processing function called by the worker.</span>
<span class="sd">        Upon loading all the information ``FileInfoLoaded`` is set to ``True``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">(),</span> <span class="n">FilterProxyModel</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">model_data</span><span class="p">()[</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">AssetSettings</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># Item description</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;config/description&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">DescriptionRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">description</span>

        <span class="c1"># For sequence items we will work out the name of the sequence</span>
        <span class="c1"># based on the frames contained in the sequence</span>
        <span class="c1"># This is a moderately costly operation hence, we&#39;re doing this here</span>
        <span class="c1"># on the thread...</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">TypeRole</span><span class="p">]</span> <span class="o">==</span> <span class="n">common</span><span class="o">.</span><span class="n">SequenceItem</span><span class="p">:</span>
            <span class="n">intframes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">]]</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">rangestring</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_ranges</span><span class="p">(</span><span class="n">intframes</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SequenceRole</span><span class="p">]</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
                <span class="sa">ur</span><span class="s1">&#39;\1</span><span class="si">{}</span><span class="s1">\3.\4&#39;</span><span class="p">)</span>
            <span class="n">startpath</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">intframes</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding</span><span class="p">))</span>
            <span class="n">endpath</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">unicode</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">intframes</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">padding</span><span class="p">))</span>
            <span class="n">seqpath</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;[</span><span class="si">{}</span><span class="s1">]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rangestring</span><span class="p">))</span>
            <span class="n">seqname</span> <span class="o">=</span> <span class="n">seqpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Setting the path names</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">StartpathRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">startpath</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">EndpathRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpath</span>
            <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqpath</span>
            <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ToolTipRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqpath</span>
            <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqname</span>
            <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">seqname</span>

            <span class="c1"># File description string</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">]:</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">]:</span>
                    <span class="n">stat</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
                    <span class="n">mtime</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">&gt;</span> <span class="n">mtime</span> <span class="k">else</span> <span class="n">mtime</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortByLastModified</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">qlast_modified</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span>

                <span class="n">info_string</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{count}</span><span class="s1"> files    |    </span><span class="si">{day}</span><span class="s1">/</span><span class="si">{month}</span><span class="s1">/</span><span class="si">{year}</span><span class="s1">  </span><span class="si">{hour}</span><span class="s1">:</span><span class="si">{minute}</span><span class="s1">   </span><span class="si">{size}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">intframes</span><span class="p">),</span>
                    <span class="n">day</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;dd&#39;</span><span class="p">),</span>
                    <span class="n">month</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;MM&#39;</span><span class="p">),</span>
                    <span class="n">year</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;yyyy&#39;</span><span class="p">),</span>
                    <span class="n">hour</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;hh&#39;</span><span class="p">),</span>
                    <span class="n">minute</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;mm&#39;</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">byte_to_string</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FileDetailsRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_string</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">]:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_mtime</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortByLastModified</span><span class="p">]</span> <span class="o">=</span> <span class="n">mtime</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="n">qlast_modified</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">]</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">st_size</span>
                <span class="n">info_string</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{day}</span><span class="s1">/</span><span class="si">{month}</span><span class="s1">/</span><span class="si">{year}</span><span class="s1">  </span><span class="si">{hour}</span><span class="s1">:</span><span class="si">{minute}</span><span class="s1">    </span><span class="si">{size}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">day</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;dd&#39;</span><span class="p">),</span>
                    <span class="n">month</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;MM&#39;</span><span class="p">),</span>
                    <span class="n">year</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;yyyy&#39;</span><span class="p">),</span>
                    <span class="n">hour</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;hh&#39;</span><span class="p">),</span>
                    <span class="n">minute</span><span class="o">=</span><span class="n">mtime</span><span class="o">.</span><span class="n">toString</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;mm&#39;</span><span class="p">),</span>
                    <span class="n">size</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">byte_to_string</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FileDetailsRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_string</span>

        <span class="c1"># Item flags</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEditable</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsDragEnabled</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;config/archived&#39;</span><span class="p">):</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsArchived</span>
        <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span>

        <span class="c1"># Finally, we set the FileInfoLoaded flag to indicate this item</span>
        <span class="c1"># has loaded the file data successfully</span>
        <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Forces a ui repaint to show the data-change</span>
        <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
            <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">indexUpdated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>


<div class="viewcode-block" id="SecondaryFileInfoWorker"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.SecondaryFileInfoWorker">[docs]</a><span class="k">class</span> <span class="nc">SecondaryFileInfoWorker</span><span class="p">(</span><span class="n">FileInfoWorker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The worker associated with the ``SecondaryFileInfoThread``.</span>

<span class="sd">    The worker performs  the same function as ``FileInfoWorker`` but</span>
<span class="sd">    it has it own queue and is concerned with iterating over all file-items.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">begin_processing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Instead of relying on a queue, we will use this to set all file information</span>
<span class="sd">        data on the source-model. There&#39;s only one thread for this worker.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_requested</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Will wait 1 sec between each tries</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">file_info_loaded</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">all_loaded</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">rowCount</span><span class="p">()):</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">):</span>
                        <span class="n">FileInfoWorker</span><span class="o">.</span><span class="n">process_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">all_loaded</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">):</span>
                        <span class="n">FileThumbnailWorker</span><span class="o">.</span><span class="n">process_index</span><span class="p">(</span>
                            <span class="n">index</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


                <span class="k">if</span> <span class="n">all_loaded</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">file_info_loaded</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_requested</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">finished</span><span class="o">.</span><span class="n">emit</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">begin_processing</span><span class="p">()</span></div>


<div class="viewcode-block" id="FileThumbnailWorker"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FileThumbnailWorker">[docs]</a><span class="k">class</span> <span class="nc">FileThumbnailWorker</span><span class="p">(</span><span class="n">BaseWorker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The worker associated with the ``FileThumbnailThread``.</span>

<span class="sd">    The worker is responsible for loading the existing thumbnail images from</span>
<span class="sd">    the cache folder, and if needed and possible, generating new thumbnails from</span>
<span class="sd">    the source file.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">Unique</span><span class="p">(</span><span class="mi">999</span><span class="p">)</span>
    <span class="n">indexes_in_progress</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@validate_index</span>
    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QModelIndex</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">process_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The static method responsible for querrying the file item&#39;s thumbnail.</span>

<span class="sd">        We will get the thumbnail&#39;s path, check if a cached thumbnail exists already,</span>
<span class="sd">        then load it. If there&#39;s no thumbnail, we will try to generate a thumbnail</span>
<span class="sd">        using OpenImageIO.</span>

<span class="sd">        Args:</span>
<span class="sd">            update (bool): Repaints the associated view if the index is visible</span>
<span class="sd">            make (bool): Will generate a thumbnail image if there isn&#39;t one already</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsArchived</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">(),</span> <span class="n">FilterProxyModel</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">model_data</span><span class="p">()[</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">AssetSettings</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">thumbnail_path</span><span class="p">()</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">SizeHintRole</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="n">common</span><span class="o">.</span><span class="n">ROW_SEPARATOR</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">image</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Checking if we can load an existing image</span>
        <span class="k">if</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">])</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">],</span> <span class="n">height</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">image</span><span class="p">:</span>
                <span class="n">color</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">],</span> <span class="sa">u</span><span class="s1">&#39;BackgroundColor&#39;</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">image</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailBackgroundRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
                <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                    <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">indexUpdated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># If the item doesn&#39;t have a saved thumbnail we will check if</span>
        <span class="c1"># OpenImageIO is able to make a thumbnail for it:</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">generate_thumbnails</span> <span class="ow">and</span> <span class="n">make</span> <span class="ow">and</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">oiio_formats</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_data</span><span class="p">()[</span><span class="n">index</span><span class="o">.</span><span class="n">row</span><span class="p">()]</span>
            <span class="n">spinner_pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">common</span><span class="o">.</span><span class="n">rsc_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;spinner&#39;</span><span class="p">),</span>
                <span class="n">data</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">SizeHintRole</span><span class="p">]</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="n">common</span><span class="o">.</span><span class="n">ROW_SEPARATOR</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">spinner_pixmap</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">ThumbnailBackgroundRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">THUMBNAIL_BACKGROUND</span>
            <span class="n">data</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">update</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">indexUpdated</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

                <span class="c1"># Emits an indexUpdated signal if successfully generated the thumbnail</span>
            <span class="n">ImageCacheWorker</span><span class="o">.</span><span class="n">process_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>


<span class="k">class</span> <span class="nc">FileInfoThread</span><span class="p">(</span><span class="n">BaseThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread controller associated with the ``FilesModel``.&quot;&quot;&quot;</span>
    <span class="n">Worker</span> <span class="o">=</span> <span class="n">FileInfoWorker</span>


<span class="k">class</span> <span class="nc">SecondaryFileInfoThread</span><span class="p">(</span><span class="n">BaseThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread controller associated with the ``FilesModel``.&quot;&quot;&quot;</span>
    <span class="n">Worker</span> <span class="o">=</span> <span class="n">SecondaryFileInfoWorker</span>


<span class="k">class</span> <span class="nc">FileThumbnailThread</span><span class="p">(</span><span class="n">BaseThread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Thread controller associated with the ``FilesModel``.&quot;&quot;&quot;</span>
    <span class="n">Worker</span> <span class="o">=</span> <span class="n">FileThumbnailWorker</span>


<span class="k">class</span> <span class="nc">FilesWidgetContextMenu</span><span class="p">(</span><span class="n">BaseContextMenu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Context menu associated with the `FilesWidget`.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesWidgetContextMenu</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="c1"># Adding persistent actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_location_toggles_menu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_mode_toggles_menu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_thumbnail_menu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_reveal_item_menu</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_copy_menu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_sort_menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_collapse_sequence_menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_display_toggles_menu</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_separator</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_refresh_menu</span><span class="p">()</span>


<div class="viewcode-block" id="FilesModel"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FilesModel">[docs]</a><span class="k">class</span> <span class="nc">FilesModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The model used store individual and collapsed sequence files found inside</span>
<span class="sd">    an asset.</span>

<span class="sd">    Every asset contains subfolders, eg. the ``scenes``, ``textures``, ``cache``</span>
<span class="sd">    folders. The model will load file-data associated with each of those</span>
<span class="sd">    subfolders and save it in ``self._data`` using a **data key**.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">       self._data = {}</span>
<span class="sd">       self._data[&#39;scenes&#39;] = {} # &#39;scenes&#39; is a data-key</span>
<span class="sd">       self._data[&#39;textures&#39;] = {} # &#39;textures&#39; is a data-key</span>

<span class="sd">    To reiterate, the name of the asset subfolders will become our *data keys*.</span>
<span class="sd">    Switching between data keys is done by emitting the ``dataKeyChanged``</span>
<span class="sd">    signal.</span>

<span class="sd">    Note:</span>
<span class="sd">        ``datakeywidget.py`` defines the widget and model used to control then</span>
<span class="sd">        current data-key.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threads</span><span class="o">=</span><span class="n">common</span><span class="o">.</span><span class="n">FTHREAD_COUNT</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_loaded</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">threads</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">FileInfoThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">n</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">FileThumbnailThread</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">n</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">_generate_thumbnails</span> <span class="o">=</span> <span class="n">local_settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span>
            <span class="sa">u</span><span class="s1">&#39;widget/</span><span class="si">{}</span><span class="s1">/generate_thumbnails&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_thumbnails</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">_generate_thumbnails</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_generate_thumbnails</span>

        <span class="c1"># The thread responsible for getting file information for all items</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">set_model</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">worker</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">SecondaryFileInfoThread</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">started</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">set_model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">reset_file_info_loaded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the file-info-loaded state to ``False``. This property is used</span>
<span class="sd">        by the ``SecondaryFileInfoWorker`` to indicate all information has</span>
<span class="sd">        been loaded.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_info_loaded</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="FilesModel.__initdata__"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FilesModel.__initdata__">[docs]</a>    <span class="nd">@initdata</span>
    <span class="k">def</span> <span class="nf">__initdata__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The method is responsible for getting the bare-bones file and</span>
<span class="sd">        sequence definitions by running a file-iterator from</span>
<span class="sd">        ``self._parent_item``.</span>

<span class="sd">        Getting all additional information, like description, item flags,</span>
<span class="sd">        thumbnails are costly and therefore are populated by thread-workers.</span>

<span class="sd">        The method will iterate through all files in every subfolder and will</span>
<span class="sd">        automatically save individual ``FileItems`` and collapsed</span>
<span class="sd">        ``SequenceItems``.</span>

<span class="sd">        Switching between the two datasets is done via emitting the</span>
<span class="sd">        ``dataTypeChanged`` signal.</span>

<span class="sd">        Note:</span>
<span class="sd">            Experiencing serious performance issues with the built-in</span>
<span class="sd">            QDirIterator on Mac OS X samba shares and the performance isn&#39;t</span>
<span class="sd">            great on windows either. Querrying the filesystem using the method</span>
<span class="sd">            is magnitudes slower than using the same methods on windows.</span>

<span class="sd">            A workaround I found was to use Python 3+&#39;s ``scandir`` module. Both</span>
<span class="sd">            on Windows and Mac OS X the performance seems to be adequate.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">add_keywords</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Adds searchable keywords given a list of string.&quot;&quot;&quot;</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
                <span class="n">ns</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;--</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">ns</span>

                <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="n">k</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="n">nk</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39; --&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">=</span> <span class="n">nk</span>

        <span class="k">def</span> <span class="nf">dflags</span><span class="p">():</span>
            <span class="sd">&quot;&quot;&quot;The default flags to apply to the item.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemNeverHasChildren</span> <span class="o">|</span>
                <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsEnabled</span> <span class="o">|</span>
                <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ItemIsSelectable</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">()</span>

        <span class="n">dkey</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_key</span><span class="p">()</span>
        <span class="n">rowsize</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSize</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">WIDTH</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">ROW_HEIGHT</span><span class="p">)</span>

        <span class="c1"># It is quicker to cache these here...</span>
        <span class="n">default_thumbnail_image</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">common</span><span class="o">.</span><span class="n">rsc_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;placeholder&#39;</span><span class="p">),</span>
            <span class="n">rowsize</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">-</span> <span class="n">common</span><span class="o">.</span><span class="n">ROW_SEPARATOR</span><span class="p">)</span>
        <span class="n">default_background_color</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">THUMBNAIL_BACKGROUND</span>

        <span class="n">thumbnails</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">defined_thumbnails</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span>
            <span class="n">common</span><span class="o">.</span><span class="n">creative_cloud_formats</span> <span class="o">+</span>
            <span class="n">common</span><span class="o">.</span><span class="n">exports_formats</span> <span class="o">+</span>
            <span class="n">common</span><span class="o">.</span><span class="n">scene_formats</span> <span class="o">+</span>
            <span class="n">common</span><span class="o">.</span><span class="n">misc_formats</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">defined_thumbnails</span><span class="p">:</span>
            <span class="n">thumbnails</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">common</span><span class="o">.</span><span class="n">rsc_path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="n">ext</span><span class="p">),</span> <span class="n">rowsize</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">common</span><span class="o">.</span><span class="n">FileItem</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">common</span><span class="o">.</span><span class="n">SequenceItem</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">}</span>

        <span class="n">seqs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">favourites</span> <span class="o">=</span> <span class="n">local_settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;favourites&#39;</span><span class="p">)</span>
        <span class="n">favourites</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">favourites</span><span class="p">]</span> <span class="k">if</span> <span class="n">favourites</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">sfavourites</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">favourites</span><span class="p">)</span>
        <span class="n">activefile</span> <span class="o">=</span> <span class="n">local_settings</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="s1">&#39;activepath/file&#39;</span><span class="p">)</span>

        <span class="c1"># Invalid asset, we&#39;ll do nothing.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_item</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_item</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">asset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_item</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_key</span><span class="p">()</span>
        <span class="n">location_is_filtered</span> <span class="o">=</span> <span class="n">location</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">NameFilters</span>
        <span class="n">location_path</span> <span class="o">=</span> <span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">location</span>
        <span class="p">))</span>

        <span class="n">nth</span> <span class="o">=</span> <span class="mi">987</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">fileentries</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">location_path</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">fileentries</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">name</span>

                <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">u</span><span class="s1">&#39;.&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="sa">u</span><span class="s1">&#39;thumbs.db&#39;</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">filename</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">continue</span>

                <span class="n">filepath</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                <span class="c1"># This line will make sure only extensions we choose to display</span>
                <span class="c1"># are actually returned. This is important for the Context widgets</span>
                <span class="k">if</span> <span class="n">location_is_filtered</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ext</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">common</span><span class="o">.</span><span class="n">NameFilters</span><span class="p">[</span><span class="n">location</span><span class="p">]:</span>
                        <span class="k">continue</span>

                <span class="c1"># Progress bar</span>
                <span class="n">c</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="o">%</span> <span class="n">nth</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">messageChanged</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                        <span class="sa">u</span><span class="s1">&#39;Found </span><span class="si">{}</span><span class="s1"> files...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                    <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">processEvents</span><span class="p">(</span>
                        <span class="n">QtCore</span><span class="o">.</span><span class="n">QEventLoop</span><span class="o">.</span><span class="n">ExcludeUserInputEvents</span><span class="p">)</span>

                <span class="n">fileroot</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location_path</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fileroot</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>

                <span class="n">seq</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">defined_thumbnails</span><span class="p">:</span>
                    <span class="n">placeholder_image</span> <span class="o">=</span> <span class="n">thumbnails</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">placeholder_image</span> <span class="o">=</span> <span class="n">default_thumbnail_image</span>

                <span class="n">flags</span> <span class="o">=</span> <span class="n">dflags</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sfavourites</span><span class="p">:</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsFavourite</span>

                <span class="k">if</span> <span class="n">activefile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">activefile</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                        <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsActive</span>

                <span class="c1"># stat = entry.stat()</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">FileItem</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">FileItem</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
                    <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span>
                    <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ToolTipRole</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span>
                    <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">SizeHintRole</span><span class="p">:</span> <span class="n">rowsize</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">:</span> <span class="p">[</span><span class="n">entry</span><span class="p">,</span> <span class="p">],</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">:</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">fileroot</span><span class="p">),</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">DescriptionRole</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">TodoCountRole</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">FileDetailsRole</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">SequenceRole</span><span class="p">:</span> <span class="n">seq</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">StartpathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">EndpathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="c1">#</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">DefaultThumbnailRole</span><span class="p">:</span> <span class="n">default_thumbnail_image</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">DefaultThumbnailBackgroundRole</span><span class="p">:</span> <span class="n">default_background_color</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailRole</span><span class="p">:</span> <span class="n">placeholder_image</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailBackgroundRole</span><span class="p">:</span> <span class="n">default_background_color</span><span class="p">,</span>
                    <span class="c1">#</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">TypeRole</span><span class="p">:</span> <span class="n">common</span><span class="o">.</span><span class="n">FileItem</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">SortByName</span><span class="p">:</span> <span class="n">filepath</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">SortByLastModified</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="c1"># self._keywords[fileroot] = fileroot</span>
                    <span class="n">add_keywords</span><span class="p">(</span><span class="n">fileroot</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>
                    <span class="n">add_keywords</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">ur</span><span class="s1">&#39;[\._\-\s]+&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

                <span class="c1"># If the file in question is a sequence, we will also save a reference</span>
                <span class="c1"># to it in `self._model_data[location][True]` dictionary.</span>
                <span class="k">if</span> <span class="n">seq</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">seqpath</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">[0]</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                            <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                            <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="n">seqpath</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">[0]</span><span class="si">{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                            <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

                    <span class="c1"># If the sequence has not yet been added to our dictionary</span>
                    <span class="c1"># of seqeunces we add it here</span>
                    <span class="k">if</span> <span class="n">seqpath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seqs</span><span class="p">:</span>  <span class="c1"># ... and create it if it doesn&#39;t exist</span>
                        <span class="n">seqname</span> <span class="o">=</span> <span class="n">seqpath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">flags</span> <span class="o">=</span> <span class="n">dflags</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                                <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span>
                                <span class="n">unicode</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">.</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                                <span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sfavourites</span><span class="p">:</span>
                            <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsFavourite</span>

                        <span class="n">seqs</span><span class="p">[</span><span class="n">seqpath</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">:</span> <span class="n">seqname</span><span class="p">,</span>
                            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">:</span> <span class="n">seqname</span><span class="p">,</span>
                            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">:</span> <span class="n">seqpath</span><span class="p">,</span>
                            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ToolTipRole</span><span class="p">:</span> <span class="n">seqpath</span><span class="p">,</span>
                            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">SizeHintRole</span><span class="p">:</span> <span class="n">rowsize</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">:</span> <span class="n">flags</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">:</span> <span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">asset</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">fileroot</span><span class="p">),</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">DescriptionRole</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">TodoCountRole</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">FileDetailsRole</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">SequenceRole</span><span class="p">:</span> <span class="n">seq</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">:</span> <span class="p">[],</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">StartpathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">EndpathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="c1">#</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">DefaultThumbnailRole</span><span class="p">:</span> <span class="n">default_thumbnail_image</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">DefaultThumbnailBackgroundRole</span><span class="p">:</span> <span class="n">default_background_color</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailPathRole</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailRole</span><span class="p">:</span> <span class="n">placeholder_image</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">ThumbnailBackgroundRole</span><span class="p">:</span> <span class="n">default_background_color</span><span class="p">,</span>
                            <span class="c1">#</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">TypeRole</span><span class="p">:</span> <span class="n">common</span><span class="o">.</span><span class="n">SequenceItem</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">SortByName</span><span class="p">:</span> <span class="n">seqpath</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">SortByLastModified</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="n">common</span><span class="o">.</span><span class="n">SortBySize</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Initializing with null-size</span>
                        <span class="p">}</span>

                    <span class="n">seqs</span><span class="p">[</span><span class="n">seqpath</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seq</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">seqs</span><span class="p">[</span><span class="n">seqpath</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">EntryRole</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seqs</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">FileItem</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># Casting the sequence data onto the model</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">seqs</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">SequenceItem</span><span class="p">])</span>

            <span class="c1"># A sequence with only one element is not a sequence!</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SequenceRole</span><span class="p">]</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">ur</span><span class="s1">&#39;\1</span><span class="si">{}</span><span class="s1">\3.\4&#39;</span><span class="p">)</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">v</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">DisplayRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="n">v</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">EditRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">filename</span>
                <span class="n">v</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="n">v</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ToolTipRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">TypeRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">FileItem</span>
                <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortByName</span><span class="p">]</span> <span class="o">=</span> <span class="n">filepath</span>
                <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SortByLastModified</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">flags</span> <span class="o">=</span> <span class="n">dflags</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">filepath</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sfavourites</span><span class="p">:</span>
                    <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsFavourite</span>

                <span class="k">if</span> <span class="n">activefile</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">activefile</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                        <span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsActive</span>

                <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">flags</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">TypeRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">FileItem</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">activefile</span><span class="p">:</span>
                    <span class="n">_firsframe</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">SequenceRole</span><span class="p">]</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="sa">ur</span><span class="s1">&#39;\1</span><span class="si">{}</span><span class="s1">\3.\4&#39;</span><span class="p">)</span>
                    <span class="n">_firsframe</span> <span class="o">=</span> <span class="n">_firsframe</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FramesRole</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">activefile</span> <span class="ow">in</span> <span class="n">_firsframe</span><span class="p">:</span>
                        <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">common</span><span class="o">.</span><span class="n">FlagsRole</span><span class="p">]</span> <span class="o">|</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsActive</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">dkey</span><span class="p">][</span><span class="n">common</span><span class="o">.</span><span class="n">SequenceItem</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span></div>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">reset_thread_worker_queues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This slot removes all queued items from the respective worker queues.</span>
<span class="sd">        Called by the ``modelAboutToBeReset`` signal.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">FileInfoWorker</span><span class="o">.</span><span class="n">reset_queue</span><span class="p">()</span>
        <span class="n">FileThumbnailWorker</span><span class="o">.</span><span class="n">reset_queue</span><span class="p">()</span>
        <span class="n">SecondaryFileInfoWorker</span><span class="o">.</span><span class="n">reset_queue</span><span class="p">()</span>
        <span class="n">ImageCacheWorker</span><span class="o">.</span><span class="n">reset_queue</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_file_info_loaded</span><span class="p">()</span>

    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">delete_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">threads</span><span class="p">[</span><span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">canDropMimeData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">supportedDropActions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">IgnoreAction</span>

    <span class="k">def</span> <span class="nf">supportedDragActions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CopyAction</span>

<div class="viewcode-block" id="FilesModel.mimeData"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FilesModel.mimeData">[docs]</a>    <span class="k">def</span> <span class="nf">mimeData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indexes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The data necessary for supporting drag and drop operations are</span>
<span class="sd">        constructed here.</span>

<span class="sd">        There is ambiguity in the absence of any good documentation I could find</span>
<span class="sd">        regarding what mime types have to be defined exactly for fully</span>
<span class="sd">        supporting drag and drop on all platforms.</span>

<span class="sd">        Note:</span>
<span class="sd">            On windows, ``application/x-qt-windows-mime;value=&quot;FileName&quot;`` and</span>
<span class="sd">            ``application/x-qt-windows-mime;value=&quot;FileNameW&quot;`` types seems to be</span>
<span class="sd">            necessary, but on MacOS a simple uri list seem to suffice.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">add_path_to_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Adds the given path to the mime data.&quot;&quot;&quot;</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">absoluteFilePath</span><span class="p">()</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QDir</span><span class="o">.</span><span class="n">toNativeSeparators</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="n">mime</span><span class="o">.</span><span class="n">setUrls</span><span class="p">(</span><span class="n">mime</span><span class="o">.</span><span class="n">urls</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QUrl</span><span class="o">.</span><span class="n">fromLocalFile</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="p">])</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">ubytearray</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">QDir</span><span class="o">.</span><span class="n">toNativeSeparators</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">mime</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span>
                <span class="s1">&#39;application/x-qt-windows-mime;value=&quot;FileName&quot;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="n">mime</span><span class="o">.</span><span class="n">setData</span><span class="p">(</span>
                <span class="s1">&#39;application/x-qt-windows-mime;value=&quot;FileNameW&quot;&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">mime</span>

        <span class="n">mime</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QMimeData</span><span class="p">()</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">keyboardModifiers</span><span class="p">()</span>
        <span class="n">no_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoModifier</span>
        <span class="n">alt_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AltModifier</span>
        <span class="n">shift_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">no_modifier</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_endpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">add_path_to_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alt_modifier</span> <span class="ow">and</span> <span class="n">shift_modifier</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
                <span class="n">add_path_to_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">alt_modifier</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_startpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="n">add_path_to_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">shift_modifier</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_paths</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                    <span class="n">add_path_to_mime</span><span class="p">(</span><span class="n">mime</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mime</span></div></div>


<span class="k">class</span> <span class="nc">DragPixmap</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The widget used to drag the dragged items pixmap and name.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DragPixmap</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pixmap</span> <span class="o">=</span> <span class="n">pixmap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">text</span>

        <span class="n">font</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">PrimaryFont</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetrics</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text_width</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">width</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_width</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">MARGIN</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">640</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">MARGIN</span> <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">640</span> <span class="k">else</span> <span class="n">width</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setFixedHeight</span><span class="p">(</span><span class="n">pixmap</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setFixedWidth</span><span class="p">(</span>
            <span class="n">pixmap</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_NoSystemBackground</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_TranslucentBackground</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_DeleteOnClose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAutoFillBackground</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowFlags</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">FramelessWindowHint</span> <span class="o">|</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">Window</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAttribute</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">WA_TransparentForMouseEvents</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjustSize</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pixmap</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the widget as a rendered pixmap.&quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">pixmap</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPixmap</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="n">pixmap</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">transparent</span><span class="p">)</span>
        <span class="n">painter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">(</span><span class="n">pixmap</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">painter</span><span class="p">,</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QPoint</span><span class="p">(),</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QRegion</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">pixmap</span>

    <span class="k">def</span> <span class="nf">paintEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="n">painter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">()</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">painter</span><span class="o">.</span><span class="n">setPen</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoPen</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setBrush</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">SECONDARY_BACKGROUND</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setOpacity</span><span class="p">(</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawRoundedRect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">(),</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">setOpacity</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="n">pixmap_rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">drawPixmap</span><span class="p">(</span><span class="n">pixmap_rect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixmap</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pixmap</span><span class="o">.</span><span class="n">rect</span><span class="p">())</span>

        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_text_width</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span>
        <span class="n">width</span> <span class="o">=</span> <span class="mi">640</span> <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="mi">640</span> <span class="k">else</span> <span class="n">width</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pixmap</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">()</span> <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="n">width</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="n">common</span><span class="o">.</span><span class="n">draw_aliased_text</span><span class="p">(</span>
            <span class="n">painter</span><span class="p">,</span>
            <span class="n">common</span><span class="o">.</span><span class="n">PrimaryFont</span><span class="p">,</span>
            <span class="n">rect</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">,</span>
            <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AlignCenter</span><span class="p">,</span>
            <span class="n">common</span><span class="o">.</span><span class="n">TEXT_SELECTED</span>
        <span class="p">)</span>
        <span class="n">painter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>


<div class="viewcode-block" id="FilesWidget"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FilesWidget">[docs]</a><span class="k">class</span> <span class="nc">FilesWidget</span><span class="p">(</span><span class="n">BaseInlineIconWidget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The view used to display the contents of a ``FilesModel`` instance.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the files widget.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            _index_timer(QTimer):   The timer responsible for pushing</span>
<span class="sd">        the visible model indexes to the thread queues to get information.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Files&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDragDropMode</span><span class="p">(</span><span class="n">QtWidgets</span><span class="o">.</span><span class="n">QAbstractItemView</span><span class="o">.</span><span class="n">DragOnly</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDragEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAcceptDrops</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDropIndicatorShown</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setAutoScroll</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Context menu, delegate, model...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_menu_cls</span> <span class="o">=</span> <span class="n">FilesWidgetContextMenu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setItemDelegate</span><span class="p">(</span><span class="n">FilesWidgetDelegate</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_model</span><span class="p">(</span><span class="n">FilesModel</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">))</span>

        <span class="c1"># Drag start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drag_source_index</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QModelIndex</span><span class="p">()</span>

        <span class="c1"># Timer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">setInterval</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FTIMER_INTERVAL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">initialize_visible_indexes</span><span class="p">)</span>

        <span class="c1"># Clearing the queues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">modelAboutToBeReset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">modelAboutToBeReset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">layoutAboutToBeChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">dataTypeChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">dataKeyChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>

        <span class="c1"># We&#39;re stopping the index timer when the model is loading.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">modelAboutToBeReset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">modelReset</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">layoutAboutToBeChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">layoutChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

        <span class="c1"># For performance&#39;s sake...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">valueChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">reset_thread_worker_queues</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderPressed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">sliderReleased</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>

        <span class="c1"># Making sure the SecondaryFileInfoWorker loads the model-data...</span>

<div class="viewcode-block" id="FilesWidget.initialize_visible_indexes"><a class="viewcode-back" href="../../api.html#gwbrowser.fileswidget.FilesWidget.initialize_visible_indexes">[docs]</a>    <span class="nd">@QtCore</span><span class="o">.</span><span class="n">Slot</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">initialize_visible_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The sourceModel() loads its data in multiples steps, there&#39;s a</span>
<span class="sd">        single-threaded walk of all sub-directories, and a threaded querry for</span>
<span class="sd">        image and file information.</span>

<span class="sd">        This slot is called by the ``_index_timer`` and queues the uninitialized</span>
<span class="sd">        indexes for the thread-workers to consume.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">needs_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">needs_thumbnail</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visible</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">generate_thumbnails</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span><span class="o">.</span><span class="n">generate_thumbnails</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verticalScrollBar</span><span class="p">()</span><span class="o">.</span><span class="n">isSliderDown</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">rowCount</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">topLeft</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c1"># Starting from the to we add all the visible, and unititalized indexes</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualRect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">rect</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">):</span>
                <span class="n">needs_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">):</span>
                <span class="n">needs_thumbnail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">visible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">rect</span><span class="o">.</span><span class="n">moveTop</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">+</span> <span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">topLeft</span><span class="p">())</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
                <span class="k">break</span>

        <span class="c1"># Here we add the last index of the window</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">bottomLeft</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="n">visible</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileInfoLoaded</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">needs_info</span><span class="p">:</span>
                    <span class="n">needs_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">generate_thumbnails</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">FileThumbnailLoaded</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">needs_thumbnail</span><span class="p">:</span>
                        <span class="n">needs_thumbnail</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="c1"># We want to make sure we keep archived items hidden. If we detect any</span>
        <span class="c1"># archived items, we will invalidate the proxy model.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">filterFlag</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">MarkedAsArchived</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsArchived</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">visible</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">invalidateFilter</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">needs_info</span><span class="p">:</span>
            <span class="n">FileInfoWorker</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="n">needs_info</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">generate_thumbnails</span><span class="p">:</span>
            <span class="n">FileThumbnailWorker</span><span class="o">.</span><span class="n">add_to_queue</span><span class="p">(</span><span class="n">needs_thumbnail</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">eventFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Custom event filter to drawm the background pixmap.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">eventFilter</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">widget</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEvent</span><span class="o">.</span><span class="n">Paint</span><span class="p">:</span>
            <span class="c1"># Let&#39;s paint the icon of the current mode</span>
            <span class="n">painter</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QPainter</span><span class="p">()</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">begin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span>
                <span class="sa">u</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QColor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">rect</span> <span class="o">=</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span>
            <span class="n">rect</span><span class="o">.</span><span class="n">moveCenter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rect</span><span class="p">()</span><span class="o">.</span><span class="n">center</span><span class="p">())</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">drawPixmap</span><span class="p">(</span><span class="n">rect</span><span class="p">,</span> <span class="n">pixmap</span><span class="p">,</span> <span class="n">pixmap</span><span class="o">.</span><span class="n">rect</span><span class="p">())</span>
            <span class="n">painter</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">inline_icons_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">buttons_hidden</span><span class="p">():</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="mi">3</span>

    <span class="k">def</span> <span class="nf">action_on_enter_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">save_data_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="n">local_settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;activepath/location&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_activated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the current item item as ``active`` and</span>
<span class="sd">        emits the ``activeLocationChanged`` and ``activeFileChanged`` signals.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">local_settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;activepath/location&#39;</span><span class="p">,</span>
                                <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span>

        <span class="n">file_info</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">))</span>
        <span class="n">filepath</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>  <span class="c1"># location/subdir/filename.ext</span>
            <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">)[</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_startpath</span><span class="p">(</span><span class="n">file_info</span><span class="o">.</span><span class="n">fileName</span><span class="p">()))</span>
        <span class="n">local_settings</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;activepath/file&#39;</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mouseDoubleClickEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Custom double - click event.</span>

<span class="sd">        A double click can `activate` an item, or it can trigger an edit event.</span>
<span class="sd">        As each item is associated with multiple editors we have to inspect</span>
<span class="sd">        the double - click location before deciding what action to take.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMouseEvent</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexAt</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">flags</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">common</span><span class="o">.</span><span class="n">MarkedAsArchived</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">rect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualRect</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

        <span class="n">thumbnail_rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">thumbnail_rect</span><span class="o">.</span><span class="n">setWidth</span><span class="p">(</span><span class="n">rect</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="n">thumbnail_rect</span><span class="o">.</span><span class="n">moveLeft</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span><span class="p">)</span>

        <span class="n">name_rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">name_rect</span><span class="o">.</span><span class="n">setLeft</span><span class="p">(</span>
            <span class="n">common</span><span class="o">.</span><span class="n">INDICATOR_WIDTH</span>
            <span class="o">+</span> <span class="n">name_rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>
            <span class="o">+</span> <span class="n">common</span><span class="o">.</span><span class="n">MARGIN</span>
        <span class="p">)</span>
        <span class="n">name_rect</span><span class="o">.</span><span class="n">setRight</span><span class="p">(</span><span class="n">name_rect</span><span class="o">.</span><span class="n">right</span><span class="p">()</span> <span class="o">-</span> <span class="n">common</span><span class="o">.</span><span class="n">MARGIN</span><span class="p">)</span>

        <span class="n">font</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFont</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">PrimaryFont</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QFontMetrics</span><span class="p">(</span><span class="n">font</span><span class="p">)</span>

        <span class="n">description_rect</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QRect</span><span class="p">(</span><span class="n">name_rect</span><span class="p">)</span>

        <span class="n">name_rect</span><span class="o">.</span><span class="n">moveTop</span><span class="p">(</span><span class="n">name_rect</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">name_rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">name_rect</span><span class="o">.</span><span class="n">setHeight</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="n">name_rect</span><span class="o">.</span><span class="n">moveTop</span><span class="p">(</span><span class="n">name_rect</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">name_rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="c1"># Moving the rectangle down one line</span>
        <span class="n">description_rect</span><span class="o">.</span><span class="n">moveTop</span><span class="p">(</span>
            <span class="n">description_rect</span><span class="o">.</span><span class="n">top</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">description_rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
        <span class="n">description_rect</span><span class="o">.</span><span class="n">setHeight</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">height</span><span class="p">())</span>
        <span class="n">description_rect</span><span class="o">.</span><span class="n">moveTop</span><span class="p">(</span><span class="n">description_rect</span><span class="o">.</span><span class="n">top</span><span class="p">(</span>
        <span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">description_rect</span><span class="o">.</span><span class="n">height</span><span class="p">()</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">metrics</span><span class="o">.</span><span class="n">lineSpacing</span><span class="p">())</span>

        <span class="n">source_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">mapToSource</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">description_rect</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description_editor_widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="n">thumbnail_rect</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">pos</span><span class="p">()):</span>
            <span class="n">ImageCache</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">pick</span><span class="p">(</span><span class="n">source_index</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">mousePressEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMouseEvent</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">mousePressEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mouseReleaseEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QMouseEvent</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_index_timer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FilesWidget</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">mouseReleaseEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">startDrag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">supported_actions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creating a custom drag object here for displaying setting hotspots.&quot;&quot;&quot;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selectionModel</span><span class="p">()</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">()</span><span class="o">.</span><span class="n">sourceModel</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">isValid</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drag_source_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="n">drag</span> <span class="o">=</span> <span class="n">QtGui</span><span class="o">.</span><span class="n">QDrag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c1"># Getting the data from the source model</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setMimeData</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">mimeData</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="p">]))</span>

        <span class="c1"># Setting our custom cursor icons</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QStyleOptionViewItem</span><span class="p">()</span>
        <span class="n">option</span><span class="o">.</span><span class="n">initFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">itemDelegate</span><span class="p">()</span><span class="o">.</span><span class="n">sizeHint</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">height</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">px</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">INLINE_ICON_SIZE</span><span class="p">)</span>

        <span class="c1"># Set drag icon</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setDragCursor</span><span class="p">(</span><span class="n">px</span><span class="p">(</span><span class="s1">&#39;CopyAction&#39;</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">CopyAction</span><span class="p">)</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setDragCursor</span><span class="p">(</span><span class="n">px</span><span class="p">(</span><span class="s1">&#39;MoveAction&#39;</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">MoveAction</span><span class="p">)</span>
        <span class="c1"># drag.setDragCursor(px(&#39;LinkAction&#39;), QtCore.Qt.LinkAction)</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setDragCursor</span><span class="p">(</span><span class="n">px</span><span class="p">(</span><span class="s1">&#39;IgnoreAction&#39;</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ActionMask</span><span class="p">)</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setDragCursor</span><span class="p">(</span><span class="n">px</span><span class="p">(</span><span class="s1">&#39;IgnoreAction&#39;</span><span class="p">),</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">IgnoreAction</span><span class="p">)</span>
        <span class="c1"># drag.setDragCursor(px(&#39;TargetMoveAction&#39;), QtCore.Qt.TargetMoveAction)</span>

        <span class="n">modifiers</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">keyboardModifiers</span><span class="p">()</span>
        <span class="n">no_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">==</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">NoModifier</span>
        <span class="n">alt_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">AltModifier</span>
        <span class="n">shift_modifier</span> <span class="o">=</span> <span class="n">modifiers</span> <span class="o">&amp;</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">ShiftModifier</span>

        <span class="c1"># Set pixmap</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">QtCore</span><span class="o">.</span><span class="n">Qt</span><span class="o">.</span><span class="n">StatusTipRole</span><span class="p">)</span>

        <span class="n">bookmark</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">data</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">ParentRole</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">bookmark</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">no_modifier</span><span class="p">:</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_endpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">alt_modifier</span> <span class="ow">and</span> <span class="n">shift_modifier</span><span class="p">:</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span><span class="s1">&#39;folder&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QFileInfo</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">dir</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">alt_modifier</span><span class="p">:</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">get_sequence_startpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">shift_modifier</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, ++&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">get_sequence_startpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">pixmap</span> <span class="o">=</span> <span class="n">ImageCache</span><span class="o">.</span><span class="n">get_rsc_pixmap</span><span class="p">(</span><span class="s1">&#39;multiples_files&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">pixmap</span> <span class="o">=</span> <span class="n">DragPixmap</span><span class="o">.</span><span class="n">pixmap</span><span class="p">(</span><span class="n">pixmap</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
        <span class="n">drag</span><span class="o">.</span><span class="n">setPixmap</span><span class="p">(</span><span class="n">pixmap</span><span class="p">)</span>
        <span class="c1"># drag.setHotSpot(pixmap)</span>

        <span class="n">drag</span><span class="o">.</span><span class="n">exec_</span><span class="p">(</span><span class="n">supported_actions</span><span class="p">)</span>

        <span class="c1"># Cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drag_source_index</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QModelIndex</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([])</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">FilesWidget</span><span class="p">()</span>
    <span class="n">widget</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">app</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2019, Gergely Wootsch.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a>.
</div>
            </div>
          </div>
      </page>
  </div></body>
</html>